<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENIGMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #f4f4f7;
      --fg: #222;
      --card: #fff;
      --muted: #666;
      --input: #f9f9f9;
      --border: #ccc;
      --accent: #007aff;
    }

    body.dark {
      --bg: #000;
      --fg: #fff;
      --card: #111;
      --muted: #aaa;
      --input: #1a1a1a;
      --border: #333;
      --accent: #0af;
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .app-container {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      margin: 20px;
    }

    .toggle-container {
      text-align: right;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .toggle-container input {
      transform: scale(1.3);
    }

    .input-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      width: 48%;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input[type="number"] {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      background: var(--input);
      color: var(--fg);
      text-align: center;
    }

    .summary {
      background: var(--input);
      border-radius: 14px;
      padding: 14px;
      margin-top: 20px;
      text-align: center;
      font-size: 14px;
      color: var(--fg);
    }

    .summary .risk {
      font-weight: bold;
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    button {
      flex: 1;
      margin: 0 5px;
      padding: 14px;
      border-radius: 14px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .win-btn { background: #34c759; }
    .loss-btn { background: #ff3b30; }
    .undo-btn { background: #ff9500; }

    .bubble-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      margin-top: 20px;
    }

    .bubble {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    .win { background: #34c759; }
    .loss { background: #ff3b30; }

    .quote-box {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-top: 12px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="toggle-container">
      <label>
        ðŸŒ™ <input type="checkbox" id="themeToggle" />
      </label>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label>IB</label>
        <input type="number" id="ib" placeholder="Initial Balance">
      </div>
      <div class="input-group">
        <label>CB</label>
        <input type="number" id="cb" placeholder="Current Balance">
      </div>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label>TAD</label>
        <input type="number" id="tad" placeholder="Total DD">
      </div>
      <div class="input-group">
        <label>Risk %</label>
        <input type="number" id="riskPercent" placeholder="10" value="10">
      </div>
    </div>

    <div class="summary">
      <div class="risk" id="riskBox">Current Risk: $0.00</div>
      <div>DD: <span id="ddBox">$0.00</span> | DD Left: <span id="ddLeftBox">$0.00</span></div>
    </div>

    <div class="buttons">
      <button class="win-btn" onclick="logTrade(true)">Win</button>
      <button class="loss-btn" onclick="logTrade(false)">Loss</button>
      <button class="undo-btn" onclick="undoLastTrade()">Undo</button>
    </div>

    <div id="streakBox" class="summary">Streak: 0</div>
    <div id="winRateBox" class="summary">Win Rate: 0%</div>
    <div class="bubble-container" id="bubbleContainer"></div>
    <div class="quote-box" id="quoteBox"></div>
  </div>

  <script>
    let pnl = 0;
    let tradeHistory = [], winStreak = 0, lossStreak = 0;

    const quotes = [
      "Probabilities, not guarantees.",
      "Focus on process, not outcome.",
      "Even perfect trades can lose.",
      "Risk is the cost of uncertainty.",
      "Edge is found in execution.",
      "Discipline creates consistency.",
      "No single trade defines you.",
      "The market doesnâ€™t owe you anything.",
      "Statistical edges play out over time.",
      "The outcome is a sample, not your skill."
    ];

    function updateRisk() {
      const ib = parseFloat(document.getElementById("ib").value) || 0;
      const cb = parseFloat(document.getElementById("cb").value) || 0;
      const tad = parseFloat(document.getElementById("tad").value) || 0;
      const percent = parseFloat(document.getElementById("riskPercent").value) || 10;

      const dd = Math.max(ib - cb, 0);
      const ddLeft = Math.max(tad - dd, 0);
      const risk = (cb >= ib ? tad : ddLeft) * percent / 100;

      document.getElementById("riskBox").textContent = `Current Risk: $${risk.toFixed(2)}`;
      document.getElementById("ddBox").textContent = `$${dd.toFixed(2)}`;
      document.getElementById("ddLeftBox").textContent = `$${ddLeft.toFixed(2)}`;

      // Save inputs
      localStorage.setItem("ib", ib);
      localStorage.setItem("cb", cb);
      localStorage.setItem("tad", tad);
      localStorage.setItem("riskPercent", percent);
    }

    function logTrade(win) {
      const r = win ? 2 : -1;
      tradeHistory.push({ win, r });
      pnl += r;
      updateBubbles(win);
      updateStreak(win);
      updateWinRate();
      showQuote();
    }

    function undoLastTrade() {
      const last = tradeHistory.pop();
      if (!last) return;
      pnl -= last.r;
      document.querySelectorAll('.bubble').item(-1)?.remove();
      winStreak = 0;
      lossStreak = 0;
      updateStreakDisplay();
      updateWinRate();
      document.getElementById("quoteBox").textContent = "";
    }

    function updateBubbles(win) {
      const b = document.createElement("div");
      b.className = `bubble ${win ? 'win' : 'loss'}`;
      document.getElementById("bubbleContainer").appendChild(b);
    }

    function updateStreak(win) {
      if (win) { winStreak++; lossStreak = 0; }
      else { lossStreak++; winStreak = 0; }
      updateStreakDisplay();
    }

    function updateStreakDisplay() {
      const s = winStreak ? `${winStreak} Win Streak` : lossStreak ? `${lossStreak} Losses` : '0';
      document.getElementById("streakBox").textContent = `Streak: ${s}`;
    }

    function updateWinRate() {
      const wins = tradeHistory.filter(t => t.win).length;
      const total = tradeHistory.length;
      const rate = total ? (wins / total * 100).toFixed(1) : 0;
      document.getElementById("winRateBox").textContent = `Win Rate: ${rate}%`;
    }

    function showQuote() {
      const quote = quotes[Math.floor(Math.random() * quotes.length)];
      document.getElementById("quoteBox").textContent = `"${quote}"`;
    }

    function loadSavedInputs() {
      const ids = ["ib", "cb", "tad", "riskPercent"];
      ids.forEach(id => {
        const saved = localStorage.getItem(id);
        if (saved !== null) {
          document.getElementById(id).value = saved;
        }
      });
      updateRisk();
    }

    function setupThemeToggle() {
      const toggle = document.getElementById("themeToggle");
      const isDark = localStorage.getItem("theme") === "dark";
      document.body.classList.toggle("dark", isDark);
      toggle.checked = isDark;

      toggle.addEventListener("change", () => {
        const useDark = toggle.checked;
        document.body.classList.toggle("dark", useDark);
        localStorage.setItem("theme", useDark ? "dark" : "light");
      });
    }

    ["ib", "cb", "tad", "riskPercent"].forEach(id =>
      document.getElementById(id).addEventListener("input", updateRisk)
    );

    loadSavedInputs();
    setupThemeToggle();
  </script>
</body>
</html>
