<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ENIGMA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#00bfff">
  <link rel="manifest" href="manifest.json">
  <style>
    html { font-size: 18px; }
    @media (max-width: 480px) { html { font-size: 20px; } }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
      text-align: center;
      overflow-x: hidden;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      margin: 5px;
    }
    .section {
      margin-bottom: 20px;
    }
    .bold { font-weight: bold; }
    .risk { color: #00bfff; font-size: 1.5rem; }
    .dd-left { font-size: 1.1rem; color: #00ffff; }
    .history-container {
      text-align: left;
      margin-top: 10px;
    }
    details summary {
      font-weight: bold;
      cursor: pointer;
      background: #111;
      padding: 10px;
      border-radius: 5px;
    }
    .history-log {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    .sim-controls button {
      padding: 12px;
      font-size: 1rem;
      margin: 5px;
    }
    .win { background: #28a745; color: white; }
    .loss { background: #dc3545; color: white; }
    .undo { background: #ff9900; color: white; }
    .bubble-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-top: 15px;
    }
    .bubble {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .bubble.win { background: #28a745; }
    .bubble.loss { background: #dc3545; }
    .quote-box {
      font-size: 1rem;
      margin-top: 15px;
      color: #aaa;
    }
  </style>
</head>
<body>

<!-- Calculator Section -->
<div class="section">
  <div class="risk">Current Risk: <span id="currentRisk">$0.00</span></div>
  <div class="dd-left">DD Left: <span id="ddLeft">$0.00</span></div>

  <div>
    IB: <input type="number" id="ib" placeholder="Initial" />
    CB: <input type="number" id="cb" placeholder="Current" />
    TAD: <input type="number" id="tad" placeholder="Total DD" />
    <input type="number" id="ddPercent" placeholder="% Risk" value="10" style="width:60px;">%
    <button onclick="updateDrawdown()">Update</button>
  </div>

  <div class="history-container">
    <details>
      <summary>üìú History</summary>
      <div class="history-log" id="historyLog"></div>
    </details>
    <div style="font-size: 0.9rem; margin-top: 6px;">
      Current DD: <span id="currentDD">$0.00</span>
    </div>
  </div>
</div>

<!-- Simulator Section -->
<div class="section sim-controls">
  <button class="win" onclick="logTrade(true)">Win</button>
  <button class="loss" onclick="logTrade(false)">Loss</button>
  <button class="undo" onclick="undoLastTrade()">Undo</button>
  <div id="streakDisplay">Streak: 0</div>
  <div id="winRateBox">Win Rate: 0%</div>
</div>

<div class="bubble-container" id="bubbleContainer"></div>
<div class="quote-box" id="quoteBox"></div>

<audio id="winSound" src="https://assets.mixkit.co/sfx/download/mixkit-achievement-bell-600.wav"></audio>
<audio id="lossSound" src="https://assets.mixkit.co/sfx/download/mixkit-wrong-answer-fail-notification-946.wav"></audio>

<script>
  let ib = 0, cb = 0, tad = 0, ddPercent = 10;
  let trades = [], pnl = 0, streak = 0, lossStreak = 0, winStreak = 0;
  const quotes = [
    "Stay calm and stick to your plan.",
    "A single loss doesn't define your strategy.",
    "Winning is about probability, not perfection.",
    "Manage risk. Trust the math.",
    "Your edge plays out over time.",
    "Think long-term, not just next trade."
  ];

  function updateDrawdown() {
    ib = parseFloat(document.getElementById('ib').value) || 0;
    cb = parseFloat(document.getElementById('cb').value) || 0;
    tad = parseFloat(document.getElementById('tad').value) || 0;
    ddPercent = parseFloat(document.getElementById('ddPercent').value) || 10;

    const currentDD = ib - cb;
    const ddLeft = tad - currentDD;
    let risk = 0;

    if (cb >= ib) {
      risk = (tad * ddPercent) / 100;
    } else {
      risk = (ddLeft * ddPercent) / 100;
    }

    document.getElementById('currentRisk').textContent = `$${risk.toFixed(2)}`;
    document.getElementById('ddLeft').textContent = `$${ddLeft.toFixed(2)}`;
    document.getElementById('currentDD').textContent = `$${currentDD.toFixed(2)}`;
    addToHistory(`CB: $${cb} | IB: $${ib} | Risk: $${risk.toFixed(2)} | DD Left: $${ddLeft.toFixed(2)}`);
  }

  function addToHistory(msg) {
    const log = document.getElementById("historyLog");
    const time = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.textContent = `[${time}] ${msg}`;
    log.prepend(div);
  }

  function logTrade(isWin) {
    const r = isWin ? 2 : -1;
    pnl += r;
    trades.push(isWin);
    streak++;
    isWin ? (winStreak++, lossStreak = 0) : (lossStreak++, winStreak = 0);
    isWin ? document.getElementById('winSound').play() : document.getElementById('lossSound').play();
    updateWinRate();
    updateStreak();
    showQuote();
    createBubble(isWin);
  }

  function undoLastTrade() {
    if (!trades.length) return;
    const last = trades.pop();
    pnl -= last ? 2 : -1;
    document.querySelectorAll('.bubble').at(-1)?.remove();
    winStreak = 0; lossStreak = 0;
    updateWinRate();
    updateStreak();
  }

  function updateWinRate() {
    const total = trades.length;
    const wins = trades.filter(Boolean).length;
    const rate = total ? ((wins / total) * 100).toFixed(1) : 0;
    document.getElementById('winRateBox').textContent = `Win Rate: ${rate}%`;
  }

  function updateStreak() {
    let msg = 'Streak: ';
    msg += winStreak >= 3 ? `${winStreak} Wins üî•` :
           lossStreak >= 3 ? `${lossStreak} Losses üßä` :
           winStreak > 0 ? `${winStreak} Win` :
           lossStreak > 0 ? `${lossStreak} Loss` : '0';
    document.getElementById('streakDisplay').textContent = msg;
  }

  function createBubble(isWin) {
    const bubble = document.createElement('div');
    bubble.className = `bubble ${isWin ? 'win' : 'loss'}`;
    document.getElementById('bubbleContainer').appendChild(bubble);
  }

  function showQuote() {
    const q = quotes[Math.floor(Math.random() * quotes.length)];
    document.getElementById('quoteBox').textContent = q;
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log("‚úÖ Service Worker Registered"))
      .catch(err => console.error("‚ùå Service Worker Error:", err));
  }
</script>
</body>
</html>
